<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>tokenICO</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="src/style.css">
    <script>

      $(document).ready(function() {
          $("div.ercAside").hide();
      });
      $(document).ready(function(){
          $(".nav-button2").click(function(){
              $("div.ercAside").show();
              $("div.bubbleKey").hide(50);
          });
      });
      $(document).ready(function(){
          $(".nav-button1").click(function(){
              $("div.ercAside").hide();
              $("div.bubbleKey").hide(50);
          });
      });
      $(document).ready(function(){
          $(".nav-button0").click(function(){
              $("div.bubbleKey").show();
              $("div.ercAside").hide();
          });
      });
      $(document).ready(function(){
          $(".nav-button3").click(function(){
              $("div.bubbleKey").hide(50);
              $("div.ercAside").hide();
          });
      });
    </script>
    <script src="https://d3js.org/d3.v4.js"></script>

  </head>
  <body>
    <div class="nav-bar">
      <h1 class="title">tokenICO</h1>

    </div>

    <div class="outerChart">

      <div class="subNavBar">
      <div>
      <div class="chartTitle">How crowdsales are experiencing a meteoric rise</div>
      <div class="subtitle">Explore initial coin offerings and blockchain token sales below</div>
      </div>
      <div class="github">
            <a href="https://github.com/inkymaze/tokenICO"><img class="header-img" alt="Icon" src="https://res.cloudinary.com/dbyoymbpd/image/upload/v1502473907/github-sign_e4ttnk.svg" height="28" width="28"></a>
      </div>
      </div>

      <div>
        <div class="filterNavBar">
          <button id="alltokens" class="nav-button0">All Tokens</button>
          <button id="year" class="nav-button1">By Year</button>
          <button id="erc20" class="nav-button2">ERC-20 Tokens</button>
          <button id="roi" class="nav-button3">ROI</button>
        </div>
        <div class="bubbleMain">
          <div class="bubbleKey">
            <p>Bubbles are sized according to USD raised at offering</p>
            <div style="left:105px;top:95px;width:24px;"class="scaleTag"><span>$100,000,000</span></div>
            <div style="left: 79px;top: 143px;width: 57px;" class="scaleTag"><span style="left: 58px;
    bottom: -9px;">$10,000,000</span></div>
            <div style="left: 72px;
    top: 164px;
    width: 63px;" class="scaleTag"><span style="left: 65px;
    bottom: -8px;">$1,000,000</span></div>
              <svg id="scaleKey" ></svg>
              <div class="colorKey">
                 <h3 class="keyTitle">Currently Traded</h3>
                <ul>
                  <li> Green = Traded </li>
                  <li> Red = Failed </li>
                  <li> Blue = Not currently traded </li>
                </ul>
              </div>
          </div>

          <div id="chartCont" class="chart" style="display: flex; justify-content: center;"></div>

          <div class="ercAside">
            <p>Listed on the Ethereum network these tokens can be exchanged with other currencies as well as ensure compatibility with dApps of the same standard protocol</p>
          </div>
        <div>
      </div>

    </div>
    <script type="text/javascript">
    let bubbleChart = (function() {

       let width = 970;
       let height = 550;

       let svg = d3.select("#chartCont")
         .append("svg")
         .attr("width", width)
         .attr("height", height)
         .append("g")
         .attr("transform", "translate(0, 0)");

       let forceXsplit = d3.forceX(function(d) {
         if(d.year === 2017) {
           return width * 0.75;
         } else if (d.year === 2016) {
           return width * 0.375;
         } else if (d.year === 2015) {
           return width * 0.16;
         } else {
           return width * 0.04;
         }
       }).strength(0.05);

       let forceXErcSplit = d3.forceX(function(d) {
         if(d.erc20 === "TRUE") {
         return width * 0.666;
         } else {
         return width * 0.2;
         }
       }).strength(0.05);

       let div = d3.select("body").append("div")
         .attr("class", "tooltip")
         .style("opacity", 0);

       let ercAside = d3.select("body").append("p")
        .attr("class", "ercAside")
        .style("opacity", 1);

       let yearsTitleX = {
       2014: width * 0.04,
       2015: width * 0.16,
       2016: width * 0.375,
       2017: width * 0.75
       };

       let ercValuesX = {
         'ERC-20': width * 0.666,
         'Others': width * 0.22
       };

       function getFillColor(data) {
         if(data.price_usd) {
              return "#7aa25c";
         } else if (data.status == "Failed") {
           return "#D84B2A";
         }else {

         return "#2F708F";
        }
       }

       function showYears() {
         let yearsData = d3.keys(yearsTitleX);
         let years = svg.selectAll('.year')
         .data(yearsData);

         years.enter().append('text')
         .attr('class', 'year')
         .attr('x', function (d) { return yearsTitleX[d]; })
         .attr('y', height * 0.10)
         .attr('text-anchor', 'middle')
         .attr("fill", "#999999")
         .text(function (d) { return d; });
       }

       function showAxis() {

        // xAxis = d3.scaleLog().range([0, width])
                // .domain([dataExtents[currentMode.xDataField][0], dataExtents[currentMode.xDataField][1]]);
                var x = d3.scaleBand().rangeRound([0, width]);
                var y = d3.scaleLinear().range([height - 50 , 50]);
                svg.append("g")
                .attr("transform", "translate(0,425)")
                .call(d3.axisBottom(x));

// Add the Y Axis
    svg.append("g")
        .call(d3.axisLeft(y));
        // d3.scaleBand().rangeRound([0, width]).padding(0.1);
        // console.log(xAxis);
        // yAxis = d3.scaleLog().range([height, 0])
  //       var yScale = d3.scale.linear()
  //       .domain([0, 100])    // values between 0 and 100
  // .range([height, 10]);
  // let yScale = d3.scaleSqrt().domain([115500,252000000]).range([4,70]).clamp(true);
  // var yAxis = d3.svg.axis()
  //           .orient("left")
  //           .scale(yScale);
  //               // .domain([dataExtents[currentMode.yDataField][0], dataExtents[currentMode.yDataField][1]]);
  //       // d3.scaleLinear().rangeRound([height, 0]);
  //       var xScale = d3.time.scale()
  //       .domain([0, 10000])    // values between for month of january
  // .range([0, 1]);
  //       var xAxis = d3.svg.axis()
  //         .orient("bottom")
  //         .scale(xScale);
      //   svg.append("g")
      //    .attr("class", "xAxis")   // give it a class so it can be used to select only xaxis labels  below
      //    .attr("transform", "translate(0," + (height) + ")")
      //    .call(xAxis);
      //
      //
      // vis.append("g")
      //      .attr("transform", "translate(0,0)")
      //      .call(yAxis);
    }

       function showScale() {
         let scaleKey = d3.selectAll(".scaleKey").append("circle")
           .attr("class", "scaleKey");

           d3.select("#scaleKey").append("circle")
              .attr('r', bubbleScale(100000000))
              .attr('class',"scaleKeyCircle")
              .attr('cx', 60)
              .attr('cy', 55);
            d3.select("#scaleKey").append("circle")
              .attr('r', bubbleScale(10000000))
              .attr('class',"scaleKeyCircle")
              .attr('cx', 60)
              .attr('cy', 88);
            d3.select("#scaleKey").append("circle")
              .attr('r', bubbleScale(1000000))
              .attr('class',"scaleKeyCircle")
              .attr('cx', 60)
              .attr('cy', 98);
       }

       function showErc() {
         let ercData = d3.keys(ercValuesX);
         let ercValues= svg.selectAll('.erc20')
           .data(ercData);

         ercValues.enter().append('text')
         .attr('class', 'erc20')
         .attr('x', function (d) { return ercValuesX[d]; })
         .attr('y', height * 0.085)
         .attr("fill", "#999999")
         .attr('text-anchor', 'middle')
         .text(function (d) { return d; });
       }

       let simulation = d3.forceSimulation()

       .force("xAxis", d3.forceX(width * 0.7).strength(0.03))
       .force("yAxis", d3.forceY(height * 0.67).strength(0.03))

       .force("preventCollide", d3.forceCollide(function(d) {
           return bubbleScale(d.usd_raised) + 1;
         }));

       d3.queue()
        .defer(d3.json, 'staticTokenData.json')
        .defer(d3.json, 'https://api.coinmarketcap.com/v1/ticker/?')
        .awaitAll(loaded);
       // defines svg content for resuable component
       // appending a pattern tag which uploads the token logo
       let defs = svg.append("defs");

       // scale the bubble proportionally give dollar range to px
       let bubbleScale = d3.scaleSqrt().domain([115500,252000000]).range([4,70]).clamp(true);




       function loaded(error, data) {

          data = data[0].map(x => Object.assign(x, data[1].find(y => y.name == x.name)));
          console.log(data);
         defs.selectAll(".token-logo")
           .data(data)
           .enter().append("pattern")
           .attr("class", ".token-logo")
           .attr("id",
             function(d) {
             // must using global regex to replace more then one space
             return d.name;
           })
           .attr("height", "100%")
           .attr("width", "100%")
           .attr("patternContentUnits", "objectBoundingBox")
           .append("image")
           .attr("height", 1)
           .attr("width", 1)
           .attr("preserveAspectRatio", "none")
           .attr("xmlns:xlink", "http://www.w3.org/1999/xlink")
           .attr("xlink:href", function(d) {
             return d.logo_path;
           });


           showScale();

         let circle = svg.selectAll("circle")
           .data(data)
           .enter().append("circle")
           .attr("class", "token")
           // give the radius of bubble appropriate scale
           .attr("r", function(d) {
             return bubbleScale(d.usd_raised);
           })

           .attr("fill", function(d) {
              return getFillColor(d);
             })

          .attr('stroke', function (d) {
            return d3.rgb(getFillColor(d)).darker(); })

           // loads bubbles with logos but freezes browser
          //  function(d) {
          //    return "url(#" + d.name.replace(/ /g, "-") + ")";
          //  })
           // loads details of each bubble which will zoom later on click
          .on("mouseover", function(d) {
              div.transition()
                  .duration(200)
                  .style("opacity", .95);


                  div.html(
                   "<br/>" + d.name + "<br/>" +
                   "USD Raised: $" + d.usd_raised + "<br/>" +
                   "Date: " + d.month + "<br/>" +
                   "Token Sale Price: $" + d.token_sale_price + "<br/>" +
                   "ERC-20 Protocol: " + d.erc20 + "<br/>" +
                   "Market Cap: $" + d.market_cap_usd + "<br/>" +
                   "--click for Whitepaper--" + "<br/>");
                   div.append("img")
                                    .attr("src", d.logo_path)
                                    .attr("width","50px")
                                    .attr("height","50px")
                   .style("left", (d3.event.pageX) + "px")
                   .style("top", (d3.event.pageY - 28) + "px");
              })
          .on("mousemove", function(){return div.style("top", (event.pageY-
              10)+"px").style("left",(event.pageX+10)+"px");})

          .on("mouseout", function(d) {
              div.transition()
                  .duration(500)
                  .style("opacity", 0);
           })
           .on("click", function(d) {window.open(d.link); });

       d3.select("#year").on('click', function() {
         svg.selectAll('.erc20').remove();
         showYears();

         simulation
         .force('charge', d3.forceManyBody().strength(-0.5))
         .force("xAxis", forceXsplit)
         .force("yAxis", d3.forceY(height * 0.535).strength(0.03))
         .force("preventCollide", d3.forceCollide(function(d) {
           return bubbleScale(d.usd_raised) + 2;
         }))
         .velocityDecay(0.29)
         .restart()
        .alphaTarget(0.2);

       });

       d3.select("#alltokens").on('click', function() {
         svg.selectAll('.erc20').remove();
         svg.selectAll('.year').remove();
         simulation.stop();
         simulation.force('charge', d3.forceManyBody().strength(-1))
         .force("xAxis", d3.forceX(width * 0.6).strength(0.03))
           .force("yAxis", d3.forceY(height * 0.5).strength(0.03))
           .force("preventCollide", d3.forceCollide(function(d) {
             return bubbleScale(d.usd_raised) + 3;
           }))
           .restart()
           .alphaTarget(0.2);


      ;
       });

       d3.select("#erc20").on('click', function() {
          svg.selectAll('.year').remove();
          showErc();

         simulation.force("xAxis", forceXErcSplit)
         .force('charge', d3.forceManyBody().strength(-0.5))
         .force("yAxis", d3.forceY(height / 2).strength(0.03))
         .force("preventCollide", d3.forceCollide(function(d) {
           return bubbleScale(d.usd_raised) + 3;

         }))
         .velocityDecay(0.4)
         .restart()
           .alphaTarget(.2);

       });

       d3.select("#roi").on('click', function() {
          svg.selectAll('.year').remove();
          svg.selectAll('.erc20').remove();
          showAxis();


        //  simulation.force("xAxis", forceXErcSplit)
        //  .force('charge', d3.forceManyBody().strength(-0.5))
        //  .force("yAxis", d3.forceY(height / 2).strength(0.03))
        //  .force("preventCollide", d3.forceCollide(function(d) {
        //    return bubbleScale(d.usd_raised) + 3;
         //
        //  }))
        //  .velocityDecay(0.4)
        //  .restart()
        //    .alphaTarget(.2);

       });

       // nodes equal circle/circles in this case
       simulation.nodes(data)
         .on('tick', ticked);

       function ticked() {
         circle
           .attr("cx", function(d) {
             return d.x;
           })
         .attr("cy", function(d) {
           return d.y;
         });

       }
     }
   });

   window.addEventListener('resize',
    bubbleChart()
   );

    </script>

    <script type="text/javascript" src="https://files.coinmarketcap.com/static/widget/currency.js"></script>
    </div>
  </body>
</html>
